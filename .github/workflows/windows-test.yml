name: Windows Build and Package

on:
  push:
    branches:
      - main  # Adjust branch name as needed
  pull_request:
    branches:
      - main  # Adjust branch name as needed

jobs:
  build:
    name: Build on Windows
    runs-on: windows-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v2

    - name: Install Vulkan SDK
      run: ./.ci/scripts/windows/install-vulkan-sdk.ps1

    - name: Configure CMake
      run: |
        refreshenv
        glslangValidator --version
        mkdir build
        cd build
        cmake -E env CXXFLAGS="/Gw" cmake -G "Visual Studio 17 2022" -A x64 -DCMAKE_POLICY_DEFAULT_CMP0069=NEW -DSUYU_ENABLE_LTO=ON -DSUYU_USE_BUNDLED_QT=1 -DSUYU_USE_BUNDLED_SDL2=1 -DSUYU_USE_QT_WEB_ENGINE=ON -DENABLE_COMPATIBILITY_LIST_DOWNLOAD=ON -DSUYU_ENABLE_COMPATIBILITY_REPORTING=${COMPAT} -DSUYU_TESTS=OFF -DUSE_DISCORD_PRESENCE=ON -DENABLE_QT_TRANSLATION=ON -DDISPLAY_VERSION=${{ parameters['version'] }} -DCMAKE_BUILD_TYPE=Release -DSUYU_CRASH_DUMPS=ON ..
        cd ..

    - name: Build with MSBuild
      run: |
        msbuild build/suyu.sln /p:Configuration=Release /maxcpucount

    - name: Package Artifacts
      run: ./.ci/scripts/windows/upload.ps1 $(BuildName)

    - name: Upload Artifacts
      uses: actions/upload-artifact@v2
      with:
        name: suyu-$(BuildName)-windows-msvc
        path: build/  # Adjust path to match the location of your artifacts
